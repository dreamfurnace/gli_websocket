name: Deploy WebSocket Server to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: gli-websocket-production
  ECS_CLUSTER: production-gli-cluster
  ECS_SERVICE: production-websocket-service
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: AWS ìê²© ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: í™˜ê²½ ë³€ìˆ˜ ìƒì„±
      run: |
        export TZ='Asia/Seoul'
        BUILD_UID=$(date '+%m.%d-%H:%M:%S')
        echo "BUILD_UID=$BUILD_UID" >> $GITHUB_ENV
        echo "ğŸ¯ Generated BUILD_UID: $BUILD_UID (KST)"

    - name: ECR ë¡œê·¸ì¸
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
        docker buildx create --use --name gli-ws-builder || docker buildx use gli-ws-builder
        docker buildx build \
          --platform linux/amd64 \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          --push \
          --build-arg BUILD_UID=${{ env.BUILD_UID }} \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:production-latest \
          .
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"

    - name: Task Definition ìƒì„± ë° ë“±ë¡
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ“ Task Definition ìƒì„± ì¤‘..."

        # VPC ì„¤ì • ì¡°íšŒ
        VPC_ID=$(aws ec2 describe-vpcs \
          --filters "Name=is-default,Values=true" \
          --query 'Vpcs[0].VpcId' \
          --output text)

        echo "VPC_ID=$VPC_ID" >> $GITHUB_ENV

        # Task Definition JSON ìƒì„± (Productionì€ ë” ë§ì€ ë¦¬ì†ŒìŠ¤ í• ë‹¹)
        cat > task-definition.json <<EOF
        {
          "family": "production-gli-websocket",
          "networkMode": "awsvpc",
          "requiresCompatibilities": ["FARGATE"],
          "cpu": "512",
          "memory": "1024",
          "executionRoleArn": "arn:aws:iam::917891822317:role/ecsTaskExecutionRole",
          "taskRoleArn": "arn:aws:iam::917891822317:role/ecsTaskExecutionRole",
          "containerDefinitions": [
            {
              "name": "websocket-server",
              "image": "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG",
              "essential": true,
              "portMappings": [
                {
                  "containerPort": 8080,
                  "protocol": "tcp"
                }
              ],
              "environment": [
                {
                  "name": "NODE_ENV",
                  "value": "production"
                },
                {
                  "name": "BUILD_UID",
                  "value": "${{ env.BUILD_UID }}"
                }
              ],
              "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                  "awslogs-group": "/ecs/production-gli-websocket",
                  "awslogs-region": "ap-northeast-2",
                  "awslogs-stream-prefix": "websocket",
                  "awslogs-create-group": "true"
                }
              }
            }
          ]
        }
        EOF

        # Task Definition ë“±ë¡
        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://task-definition.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)

        echo "TASK_DEF_ARN=$NEW_TASK_DEF_ARN" >> $GITHUB_ENV
        echo "âœ… Task Definition ë“±ë¡ ì™„ë£Œ: $NEW_TASK_DEF_ARN"

    - name: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
      run: |
        echo "ğŸš€ ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì‹œì‘..."

        # ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        SERVICE_EXISTS=$(aws ecs describe-services \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE \
          --query 'services[0].serviceName' \
          --output text 2>/dev/null || echo "")

        if [ -z "$SERVICE_EXISTS" ] || [ "$SERVICE_EXISTS" = "None" ]; then
          echo "âš ï¸  ECS ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "ì„œë¹„ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤."
          exit 1
        fi

        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --task-definition ${{ env.TASK_DEF_ARN }} \
          --force-new-deployment

        echo "âœ… ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

    - name: ë°°í¬ ê²€ì¦
      run: |
        echo "ğŸ” ë°°í¬ ê²€ì¦ ì‹œì‘..."

        for i in {1..120}; do
          DEPLOYMENT_STATUS=$(aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --query "services[0].deployments[?status=='PRIMARY'].rolloutState" \
            --output text)

          if [ "$DEPLOYMENT_STATUS" = "COMPLETED" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ! (${i}ì´ˆ)"
            break
          elif [ $i -eq 120 ]; then
            echo "âš ï¸  ë°°í¬ ê²€ì¦ íƒ€ì„ì•„ì›ƒ (120ì´ˆ)"
            break
          fi

          sleep 1
        done

    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ GLI WebSocket Server Production ë°°í¬ ì„±ê³µ!"
          echo "ğŸŒ URL: wss://ws.glibiz.com"
          echo "ğŸ·ï¸  BUILD_UID: ${{ env.BUILD_UID }}"
          echo "ğŸ³ Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
          echo "ğŸ“Œ Git SHA: ${{ github.sha }}"
        else
          echo "âŒ GLI WebSocket Server Production ë°°í¬ ì‹¤íŒ¨!"
          echo "âš ï¸  ë¡¤ë°±ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        fi
